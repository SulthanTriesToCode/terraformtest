name: Deploy

on:
    push:
        branches:
            - main

jobs:
    deploy:
        runs-on: ubuntu-latest

        steps:
          - name: Checkout repository
            uses: actions/checkout@v2

          - name: Install dependencies
            run: |
              sudo apt-get update
              sudo apt-get install -y jq sshpass awscli

          - name: Set up AWS CLI
            run: |
              aws configure set aws_access_key_id ${{ secrets.AWS_ACCESS_KEY_ID }}
              aws configure set aws_secret_access_key ${{ secrets.AWS_SECRET_ACCESS_KEY }}
              aws configure set aws_session_token ${{ secrets.AWS_SESSION_TOKEN }}
              aws configure set region us-east-1
    
          - name: Install Terraform
            run: |
              sudo apt update && sudo apt install -y gpg
              wget -O- https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
              echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
              sudo apt update
              sudo apt install -y terraform

          - name: Run deploy script
            run: |
              chmod +x deploy.sh
              echo yes | ./deploy.sh

          - name: Add host keys to known_hosts
            run: |
              db_public_hostname=$(terraform output -raw db_public_hostname)
              app_public_hostname=$(terraform output -raw app_public_hostname)
              ssh-keyscan -H $db_public_hostname >> ~/.ssh/known_hosts
              ssh-keyscan -H $app_public_hostname >> ~/.ssh/known_hosts
    
          - name: Destroy Terraform on failure
            if: failure()
            run: |
              cd infra
              terraform destroy -auto-approve